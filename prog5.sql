-- -----------------------------
-- 1. Create Base Tables
-- -----------------------------

-- Step 1: Create DEPARTMENT without MGRSSN to avoid circular reference
CREATE TABLE DEPARTMENT (
    DNO VARCHAR(20) PRIMARY KEY,
    DNAME VARCHAR(20),
    MGRSTARTDATE DATE
);

-- Step 2: Create EMPLOYEE
CREATE TABLE EMPLOYEE (
    SSN VARCHAR(20) PRIMARY KEY,
    FNAME VARCHAR(20),
    LNAME VARCHAR(20),
    ADDRESS VARCHAR(20),
    SEX CHAR(1),
    SALARY INT,
    SUPERSSN VARCHAR(20),
    DNO VARCHAR(20),
    FOREIGN KEY (SUPERSSN) REFERENCES EMPLOYEE(SSN) ON DELETE CASCADE,
    FOREIGN KEY (DNO) REFERENCES DEPARTMENT(DNO) ON DELETE CASCADE
);

-- Step 3: Alter DEPARTMENT to add MGRSSN FK after EMPLOYEE exists
ALTER TABLE DEPARTMENT ADD MGRSSN VARCHAR(20);
ALTER TABLE DEPARTMENT ADD CONSTRAINT fk_mgrssn FOREIGN KEY (MGRSSN) REFERENCES EMPLOYEE(SSN);

-- -----------------------------
-- 2. Create Remaining Tables
-- -----------------------------

CREATE TABLE DLOCATION (
    DLOC VARCHAR(20),
    DNO VARCHAR(20),
    PRIMARY KEY (DNO, DLOC),
    FOREIGN KEY (DNO) REFERENCES DEPARTMENT(DNO) ON DELETE CASCADE
);

CREATE TABLE PROJECT (
    PNO INT PRIMARY KEY,
    PNAME VARCHAR(20),
    PLOCATION VARCHAR(20),
    DNO VARCHAR(20),
    FOREIGN KEY (DNO) REFERENCES DEPARTMENT(DNO) ON DELETE CASCADE
);

CREATE TABLE WORKS_ON (
    HOURS INT,
    SSN VARCHAR(20),
    PNO INT,
    PRIMARY KEY (SSN, PNO),
    FOREIGN KEY (SSN) REFERENCES EMPLOYEE(SSN) ON DELETE CASCADE,
    FOREIGN KEY (PNO) REFERENCES PROJECT(PNO) ON DELETE CASCADE
);

-- -----------------------------
-- 3. Insert Sample Data
-- -----------------------------

-- First insert minimal departments (without MGRSSN yet)
INSERT INTO DEPARTMENT (DNO, DNAME, MGRSTARTDATE) VALUES
('1', 'ACCOUNTS', '2001-01-01'),
('2', 'IT', '2016-08-01'),
('3', 'ECE', '2008-06-01'),
('4', 'ISE', '2015-08-01'),
('5', 'CSE', '2002-06-01');

-- Insert employees (including managers)
INSERT INTO EMPLOYEE VALUES
('RNSECE01', 'JOHN', 'SCOTT', 'BANGALORE', 'M', 450000, NULL, '3'),
('RNSCSE05', 'VIKAS', 'KUMAR', 'MYSORE', 'M', 800000, NULL, '5'),  -- Manager
('RNSCSE04', 'PAVAN', 'HEGDE', 'MANGALORE', 'M', 650000, 'RNSCSE05', '5'),
('RNSCSE03', 'EDWARD', 'SCOTT', 'MYSORE', 'M', 500000, 'RNSCSE04', '5'),
('RNSCSE02', 'HEARN', 'BAKER', 'BANGALORE', 'M', 700000, 'RNSCSE03', '5'),
('RNSCSE01', 'JAMES', 'SMITH', 'BANGALORE', 'M', 500000, 'RNSCSE02', '5'),
('RNSACC02', 'ALOK', 'NATH', 'BANGALORE', 'M', 600000, NULL, '1'),
('RNSIT01', 'RAHUL', 'JAIN', 'BANGALORE', 'M', 550000, NULL, '2'),
('RNSISE01', 'RAJ', 'SINGH', 'MANGALORE', 'M', 590000, NULL, '4');

-- Now update DEPARTMENT with MGRSSN
UPDATE DEPARTMENT SET MGRSSN = 'RNSACC02' WHERE DNO = '1';
UPDATE DEPARTMENT SET MGRSSN = 'RNSIT01' WHERE DNO = '2';
UPDATE DEPARTMENT SET MGRSSN = 'RNSECE01' WHERE DNO = '3';
UPDATE DEPARTMENT SET MGRSSN = 'RNSISE01' WHERE DNO = '4';
UPDATE DEPARTMENT SET MGRSSN = 'RNSCSE05' WHERE DNO = '5';

-- Insert DLOCATION data
INSERT INTO DLOCATION VALUES 
('BANGALORE', '1'),
('BANGALORE', '2'),
('BANGALORE', '3'),
('MANGALORE', '4'),
('MANGALORE', '5');

-- Insert PROJECT data
INSERT INTO PROJECT VALUES 
(100, 'IOT', 'BANGALORE', '5'),
(101, 'CLOUD', 'BANGALORE', '5'),
(102, 'BIGDATA', 'BANGALORE', '5'),
(103, 'SENSORS', 'BANGALORE', '3'),
(104, 'BANK MANAGEMENT', 'BANGALORE', '1');

-- Insert WORKS_ON data
INSERT INTO WORKS_ON VALUES 
(4, 'RNSCSE01', 100),
(6, 'RNSCSE01', 101),
(8, 'RNSCSE01', 102),
(10, 'RNSCSE02', 100),
(3, 'RNSCSE04', 100);

-- -----------------------------
-- 4. Queries
-- -----------------------------

-- Q1: Projects managed by or worked on by employees with last name 'SCOTT'
(SELECT DISTINCT P.PNO
 FROM PROJECT P
 JOIN DEPARTMENT D ON P.DNO = D.DNO
 JOIN EMPLOYEE E ON D.MGRSSN = E.SSN
 WHERE E.LNAME = 'SCOTT')
UNION
(SELECT DISTINCT P1.PNO
 FROM PROJECT P1
 JOIN WORKS_ON W ON P1.PNO = W.PNO
 JOIN EMPLOYEE E1 ON W.SSN = E1.SSN
 WHERE E1.LNAME = 'SCOTT');

-- Q2: Employees working on 'IOT' project and their salary increased by 10%
SELECT E.FNAME, E.LNAME, ROUND(1.1 * E.SALARY, 2) AS INCR_SAL
FROM EMPLOYEE E
JOIN WORKS_ON W ON E.SSN = W.SSN
JOIN PROJECT P ON W.PNO = P.PNO
WHERE P.PNAME = 'IOT';

-- Q3: Total, max, min, avg salary in 'ACCOUNTS' department
SELECT SUM(E.SALARY) AS TOTAL_SAL,
       MAX(E.SALARY) AS MAX_SAL,
       MIN(E.SALARY) AS MIN_SAL,
       AVG(E.SALARY) AS AVG_SAL
FROM EMPLOYEE E
JOIN DEPARTMENT D ON E.DNO = D.DNO
WHERE D.DNAME = 'ACCOUNTS';

-- Q4: Employees who worked on all projects in department 'CSE' (DNO = '5')
SELECT E.FNAME, E.LNAME
FROM EMPLOYEE E
WHERE NOT EXISTS (
    SELECT P.PNO
    FROM PROJECT P
    WHERE P.DNO = '5'
    AND P.PNO NOT IN (
        SELECT W.PNO
        FROM WORKS_ON W
        WHERE W.SSN = E.SSN
    )
);

-- Q5: Departments with more than 5 employees earning above 600000
SELECT D.DNO, COUNT(*) AS EMP_COUNT
FROM DEPARTMENT D
JOIN EMPLOYEE E ON D.DNO = E.DNO
WHERE E.SALARY > 600000
GROUP BY D.DNO
HAVING COUNT(*) > 5;
