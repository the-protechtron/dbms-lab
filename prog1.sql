-- ------- CREATION -------

-- 1. Publisher Table
CREATE TABLE PUBLISHER (
    NAME VARCHAR(50) PRIMARY KEY,
    PHONE VARCHAR(15),
    ADDRESS VARCHAR(100)
);

-- 2. Book Table
CREATE TABLE BOOK (
    BOOK_ID INT PRIMARY KEY,
    TITLE VARCHAR(50),
    PUB_YEAR VARCHAR(20),
    PUBLISHER_NAME VARCHAR(50),
    FOREIGN KEY (PUBLISHER_NAME) REFERENCES PUBLISHER(NAME) ON DELETE CASCADE
);

-- 3. Book Authors Table
CREATE TABLE BOOK_AUTHORS (
    AUTHOR_NAME VARCHAR(50),
    BOOK_ID INT,
    PRIMARY KEY (BOOK_ID, AUTHOR_NAME),
    FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE
);

-- 4. Library Branch Table
CREATE TABLE LIBRARY_BRANCH (
    BRANCH_ID INT PRIMARY KEY,
    BRANCH_NAME VARCHAR(100),
    ADDRESS VARCHAR(100)
);

-- 5. Book Copies Table
CREATE TABLE BOOK_COPIES (
    NO_OF_COPIES INT,
    BOOK_ID INT,
    BRANCH_ID INT,
    PRIMARY KEY (BOOK_ID, BRANCH_ID),
    FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE,
    FOREIGN KEY (BRANCH_ID) REFERENCES LIBRARY_BRANCH(BRANCH_ID) ON DELETE CASCADE
);

-- 6. Card Table (renamed to avoid reserved word conflicts)
CREATE TABLE LIBRARY_CARD (
    CARD_NO INT PRIMARY KEY
);

-- 7. Book Lending Table
CREATE TABLE BOOK_LENDING (
    DATE_OUT DATE,
    DUE_DATE DATE,
    BOOK_ID INT,
    BRANCH_ID INT,
    CARD_NO INT,
    PRIMARY KEY (BOOK_ID, BRANCH_ID, CARD_NO),
    FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE,
    FOREIGN KEY (BRANCH_ID) REFERENCES LIBRARY_BRANCH(BRANCH_ID) ON DELETE CASCADE,
    FOREIGN KEY (CARD_NO) REFERENCES LIBRARY_CARD(CARD_NO) ON DELETE CASCADE
);

-- ------- INSERTION -------

-- Publishers
INSERT INTO PUBLISHER VALUES ('MCGRAW-HILL', '9989076587', 'BANGALORE');
INSERT INTO PUBLISHER VALUES ('PEARSON', '9889076565', 'NEWDELHI');
INSERT INTO PUBLISHER VALUES ('RANDOM HOUSE', '7455679345', 'HYDERABAD');
INSERT INTO PUBLISHER VALUES ('HACHETTE LIVRE', '8970862340', 'CHENNAI');
INSERT INTO PUBLISHER VALUES ('GRUPO PLANETA', '7756120238', 'BANGALORE');

-- Books
INSERT INTO BOOK VALUES (1, 'DBMS', '2017', 'MCGRAW-HILL');
INSERT INTO BOOK VALUES (2, 'ADBMS', '2016', 'MCGRAW-HILL');
INSERT INTO BOOK VALUES (3, 'CN', '2016', 'PEARSON');
INSERT INTO BOOK VALUES (4, 'CG', '2015', 'GRUPO PLANETA');
INSERT INTO BOOK VALUES (5, 'OS', '2016', 'PEARSON');

-- Authors
INSERT INTO BOOK_AUTHORS VALUES ('NAVATHE', 1);
INSERT INTO BOOK_AUTHORS VALUES ('NAVATHE', 2);
INSERT INTO BOOK_AUTHORS VALUES ('TANENBAUM', 3);
INSERT INTO BOOK_AUTHORS VALUES ('EDWARD ANGEL', 4);
INSERT INTO BOOK_AUTHORS VALUES ('GALVIN', 5);

-- Library Branches
INSERT INTO LIBRARY_BRANCH VALUES (10, 'RR NAGAR', 'BANGALORE');
INSERT INTO LIBRARY_BRANCH VALUES (11, 'RNSIT', 'BANGALORE');
INSERT INTO LIBRARY_BRANCH VALUES (12, 'RAJAJINAGAR', 'BANGALORE');
INSERT INTO LIBRARY_BRANCH VALUES (13, 'NITTE', 'MANGALORE');
INSERT INTO LIBRARY_BRANCH VALUES (14, 'MANIPAL', 'UDUPI');

-- Book Copies
INSERT INTO BOOK_COPIES VALUES (10, 1, 10);
INSERT INTO BOOK_COPIES VALUES (5, 1, 11);
INSERT INTO BOOK_COPIES VALUES (2, 2, 12);
INSERT INTO BOOK_COPIES VALUES (5, 2, 13);
INSERT INTO BOOK_COPIES VALUES (7, 3, 14);
INSERT INTO BOOK_COPIES VALUES (1, 5, 10);
INSERT INTO BOOK_COPIES VALUES (3, 4, 11);

-- Library Cards
INSERT INTO LIBRARY_CARD VALUES (100);
INSERT INTO LIBRARY_CARD VALUES (101);
INSERT INTO LIBRARY_CARD VALUES (102);
INSERT INTO LIBRARY_CARD VALUES (103);
INSERT INTO LIBRARY_CARD VALUES (104);

-- Book Lending
INSERT INTO BOOK_LENDING VALUES ('2017-01-01', '2017-06-01', 1, 10, 101);
INSERT INTO BOOK_LENDING VALUES ('2017-01-11', '2017-03-11', 3, 14, 101);
INSERT INTO BOOK_LENDING VALUES ('2017-02-21', '2017-04-21', 2, 13, 101);
INSERT INTO BOOK_LENDING VALUES ('2017-03-15', '2017-07-15', 4, 11, 101);
INSERT INTO BOOK_LENDING VALUES ('2017-04-12', '2017-05-12', 1, 11, 104);

-- -------- QUERIES ----------

-- 1. All book details
SELECT 
    B.BOOK_ID, 
    B.TITLE, 
    B.PUBLISHER_NAME, 
    A.AUTHOR_NAME, 
    C.NO_OF_COPIES, 
    L.BRANCH_ID,
    L.BRANCH_NAME
FROM 
    BOOK B
JOIN BOOK_AUTHORS A ON B.BOOK_ID = A.BOOK_ID
JOIN BOOK_COPIES C ON B.BOOK_ID = C.BOOK_ID
JOIN LIBRARY_BRANCH L ON C.BRANCH_ID = L.BRANCH_ID;

-- 2. Borrowers who borrowed more than 3 books between Jan and Jun 2017
SELECT CARD_NO 
FROM BOOK_LENDING 
WHERE DATE_OUT BETWEEN '2017-01-01' AND '2017-06-30'
GROUP BY CARD_NO 
HAVING COUNT(*) > 3;

-- 3. Delete a book and related data
DELETE FROM BOOK WHERE BOOK_ID = 3;

-- 4. Simulated partition query: Books published before 2016
SELECT * FROM BOOK WHERE PUB_YEAR < '2016';

-- Simulated partition query: Books published in or after 2016
SELECT * FROM BOOK WHERE PUB_YEAR >= '2016';

-- 5. View of books and number of copies
CREATE OR REPLACE VIEW V_BOOKS AS
SELECT 
    B.BOOK_ID, 
    B.TITLE, 
    SUM(C.NO_OF_COPIES) AS TOTAL_COPIES
FROM 
    BOOK B
JOIN BOOK_COPIES C ON B.BOOK_ID = C.BOOK_ID
GROUP BY B.BOOK_ID, B.TITLE;
